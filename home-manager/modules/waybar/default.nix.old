{ pkgs, config, lib, ... }:
let
  cfg = config.lily.waybar;
in
{
  options.lily.waybar.enable = lib.mkEnableOption "activate waybar";
  config = lib.mkIf cfg.enable {
    home.packages = with pkgs; [
      pavucontrol
      networkmanagerapplet
      blueman
    ];
    programs.waybar = {
      enable = true;
      style = ./style.css;

      settings = {
        mainBar = {
          layer = "top";
          position = "top";
          mode = "dock";
          height = 40;
          tray.icon-size = 15;

          modules-left = [
            "custom/icon"
            "custom/separator"
            "cpu"
            "memory"
            "temperature"
            "battery"
            "custom/separator"
            "custom/separator"
            "custom/screenshot"
            "tray"
            "hyprland/workspaces"
          ];

          modules-center = [ "hyprland/window" ];
          modules-right = [
            "mpris"
            "pulseaudio"
            "network"
            "bluetooth"
            "custom/wallchange"
            "custom/themechange"
            "clock"
          ];

          mpris = {
            format = "{player_icon}{status_icon} <small><i>[{position}/{length}]</i></small> {title} - {artist}";
            tooltip-format = "{player_icon}{status_icon} [{position}/{length}] {title} - {artist}";
            title-len = 20;
            artist-len = 10;
            interval = 1;
            player-icons = {
              default = "";
              mpv = "üéµ ";
              spotify = "ÔÜº ";
            };
            status-icons = {
              playing = "‚ñ∂";
              stopped = "Û∞ìõ";
              paused = "Û∞è§";
            };
            on-click-middle = "playerctld shift";
          };

          cpu = {
            interval = 10;
            format = "Óâ¶ {usage}";
            max-length = 10;
          };

          memory = {
            interval = 30;
            format = "Ôë≤ {used:0.1f}G";
            max-length = 10;
          };

          temperatures = {
            thermal-zone = 0;
            critical-threshold = 90;
            format-critical = "Ôãá {temperatureC}¬∞C";
            format = "Ôãá {temperatureC}¬∞C";
          };

          battery = {
            interval = 30;
            states = {
              warning = 30;
              critical = 15;
            };
            format = "{icon} {capacity}%";
            format-charging = "Ó¥ì {icon} {capacity}%";
            format-icons = [ "ÔâÉ " "ÔâÇ " "ÔâÅ " "ÔâÄ " ];
            max-length = 25;
          };

          pulseaudio = {
            format = "{icon} <b>{volume}</b>";
            format-bluetooth = "ÔÄ• Ó§•";
            format-bluetooth-muted = "Ôö© Ôäî";
            format-muted = "ÔÄ¶";
            format-icons = {
              default = [ "ÔÄß" "Û∞ïæ" "ÔÄ®" ];
            };
            on-click = "${pkgs.pavucontrol}/bin/pavucontrol";
          };

          network = {
            format-wifi = "Û∞ñ© {essid}";
            on-click = "${pkgs.networkmanagerapplet}/bin/nm-connection-editor";
            format-ethernet = "Û∞àÄ wired";
            format-disconnected = "";
            tooltip-format = "{ifname} via {gwaddr} Ôûñ";
            tooltip-format-wifi = "{essid} ({signalStrength}%) Ôá´";
            tooltip-format-ethernet = "{ifname} ÔÉÅ";
            tooltip-format-disconnected = "Disconnected";
          };

          bluetooth = {
            tooltip = true;
            on-click = "${pkgs.blueman}/bin/blueman-manager";
          };

          clock = {
            format = "Û∞É∞  {:%d.%m.%y Û∞áô %H:%M}";
          };

          "custom/icon" = {
            format = "Ôåì ";
            # on-click = "${config.lily.wlogout.logoutlaunch}/bin/logoutlaunch";
          };

          "custom/screenshot" = {
            format = "Ó≠å ";
            on-click = "GRIM_DEFAULT_DIR=${config.xdg.configHome}/../Pictures/Screenshots ${pkgs.grim}/bin/grim";
          };

          "custom/separator" = {
            format = " ";
          };

          # "custom/wallchange" = {
          #   format = "Û∞âº {}";
          #   tooltip = true;
          #   exec = "echo ; echo Û∞Üä switch wallpaper";
          #   on-click = "${inputs.wall-utils.packages.${pkgs.system}.wall-utils}/bin/wall-utils next";
          #   on-click-right = "${inputs.wall-utils.packages.${pkgs.system}.wall-utils}/bin/wall-utils previous";
          #   on-click-middle = "${inputs.wall-utils.packages.${pkgs.system}.wall-utils}/bin/wall-utils select";
          #   # interval = 3600; # once every day
          # };

          "hyprland/workspaces" = {
            format = "<span color=\"#b4befe\">{icon}</span>"; # lavender
            tooltip = false;
            all-outputs = false;
            current-only = true;
            sort-by-number = true;
            persistent-workspaces = {
              "1" = "";
              "2" = "";
              "3" = "";
              "4" = "";
              "5" = "";
              "6" = "";
              "7" = "";
              "8" = "";
              "9" = "";
              "10" = "";
            };
            format-icons = {
              "1" = "ÔëÑ";
              "2" = "ÔëÑ";
              "3" = "ÔëÑ";
              "4" = "ÔëÑ";
              "5" = "ÔëÑ";
              "6" = "ÔëÑ";
              "7" = "ÔëÑ";
              "8" = "ÔëÑ";
              "9" = "ÔëÑ";
              "10" = "<span color=\"#74c7ec\">Û∞ä†</span>"; # sapphire
              urgent = "<span color=\"#74c7ec\">ÔÅ™</span>"; # sapphire
              active = "<span color=\"#89b4fa\">Û∞ÆØ</span>"; # blue
              default = "ÔëÑ";
            };
          };

          "hyprland/window" = {
            format = "{}";
            rewrite = {
              "" = "There is no place like ~";
            };
            max-length = 200;
            seperate-outputs = true;
          };
        };
      };
    };
    home.file.".config/waybar/themes/theme.css" = { source = ./themes/Catppuccin-Mocha.css; };
  };
}
